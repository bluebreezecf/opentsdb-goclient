package client

import (
	"encoding/json"
	"math"
	"testing"
)

func TestDataPointUnmarshal(t *testing.T) {
	for i, test := range []struct {
		json   string
		err    bool
		sorted bool
		length int
		extra  func(t *testing.T, qri *QueryRespItem)
	}{
		{"{}", false, false, 0, nil},
		{`{"metric":"test.c.5","tags":{"x":"a","y":"y"},"aggregateTags":[],"dps":{}}`, false, true, 0, nil},
		{`{"metric":"test.c.5","tags":{"x":"a","y":"y"},"aggregateTags":[],"dps":{"1572092230000":25791430000,"1572092235000":25791435000,"1572092240000":25791440000,"1572092245000":25791445000,"1572092250000":25791450000,"1572092255000":25791455000,"1572092260000":25791460000,"1572092265000":25791465000,"1572092270000":25791470000,"1572092275000":25791475000,"1572092280000":25791480000,"1572092285000":25791485000,"1572092290000":25791490000,"1572092295000":25791495000,"1572092300000":25791500000,"1572092305000":25791505000,"1572092310000":25791510000,"1572092315000":25791515000,"1572092320000":25791520000,"1572092325000":25791525000,"1572092330000":25791530000,"1572092335000":25791535000,"1572092340000":25791540000,"1572092345000":25791545000,"1572092350000":25791550000,"1572092355000":25791555000,"1572092360000":25791560000,"1572092365000":25791565000,"1572092370000":25791570000,"1572092375000":25791575000,"1572092380000":25791580000,"1572092385000":25791585000,"1572092390000":25791590000,"1572092395000":25791595000,"1572092400000":25791600000,"1572092405000":25791605000,"1572092410000":25791610000,"1572092415000":25791615000,"1572092420000":25791620000,"1572092425000":25791625000,"1572092430000":25791630000,"1572092435000":25791635000,"1572092440000":25791640000,"1572092445000":25791645000,"1572092450000":25791650000,"1572092455000":25791655000,"1572092460000":25791660000,"1572092465000":25791665000,"1572092470000":25791670000,"1572092475000":25791675000,"1572092480000":25791680000,"1572092485000":25791685000,"1572092490000":25791690000,"1572092495000":25791695000,"1572092500000":25791700000,"1572092505000":25791705000,"1572092510000":25791710000,"1572092515000":25791715000,"1572092520000":25791720000,"1572092525000":25791725000,"1572092530000":25791730000,"1572092535000":25791735000,"1572092540000":25791740000,"1572092545000":25791745000,"1572092550000":25791750000,"1572092555000":25791755000,"1572092560000":25791760000,"1572092565000":25791765000,"1572092570000":25791770000,"1572092575000":25791775000,"1572092580000":25791780000,"1572092585000":25791785000,"1572092590000":null}}`, false, true, 73, testData1},
		{`{"metric":"test.c.5","tags":{"x":"a","y":"y"},"aggregateTags":[],"dps":{"2572092230000":25791430000,"1572092235000":25791435000}}`, false, false, 2, testData2},
		{`{"dps":{"1572092235000":25791435000}}`, false, true, 1, nil},
		{`{"dps":{ "1572092235000": 25791435000 }}`, false, true, 1, nil},
		{`{"dps":{"1572092235000":2x}}`, true, false, 0, nil},
		{`{"dps":{2572092230000:25791430000}`, true, false, 0, nil},
		{`{"dps":{2572092230000:25791430000}}`, true, false, 0, nil},
	} {
		var qri QueryRespItem
		err := json.Unmarshal([]byte(test.json), &qri)
		if (err != nil) != test.err {
			t.Errorf("%d: got %v, want err==%v", i, err, test.err)
		}
		if test.err {
			continue
		}
		if test.length != len(qri.Dps.dps) {
			t.Errorf("%d: got len %d, want %v", i, len(qri.Dps.dps), test.length)
		}
		if test.extra != nil {
			test.extra(t, &qri)
		}
	}
}

func testData1(t *testing.T, qri *QueryRespItem) {
	dps := qri.Dps.dps
	if dps[0].Timestamp != 1572092230000 || dps[0].Value.(float64) != 25791430000 {
		t.Errorf("data not as expected, got %v, want 1572092230000: 25791430000", dps[0])
	}
	if dps[72].Timestamp != 1572092590000 || !math.IsNaN(dps[72].Value.(float64)) {
		t.Errorf("data not as expected, got %v, want 1572092590000: NaN", dps[72])
	}
}

func testData2(t *testing.T, qri *QueryRespItem) {
	dps := qri.GetDataPoints()
	if dps[0].Timestamp != 1572092235000 || dps[0].Value.(float64) != 25791435000 {
		t.Errorf("data not as expected, got %v, want 1572092235000: 25791435000", dps[0])
	}
	if dps[1].Timestamp != 2572092230000 || dps[1].Value.(float64) != 25791430000 {
		t.Errorf("data not as expected, got %v, want 2572092230000: 25791430000", dps[1])
	}
}
